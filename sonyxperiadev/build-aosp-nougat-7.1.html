										<dt id="build-experimental-aosp-nougat-7-1"><a class="question" href="#build-experimental-aosp-nougat-7-1">Build EXPERIMENTAL AOSP Nougat 7.1</a></dt>
									<dd><p>This guide assumes you run Ubuntu (we used Ubuntu 14.04 LTS), but it should work in a similar way on any Linux-based system. To use these instructions, you should be familiar with Android development. Follow the steps below to build Android Nougat on an unlocked Xperia device. The instructions will guide you through each step from how to prepare your environment and install all necessary tools to downloading and configuring the code, before you can finally build AOSP images and flash them on your device.</p>
<p><strong>Prepare your Java environment<br />
</strong>To prevent errors generated by having the wrong version of Java installed on your computer, we will start by removing any conflicting Java version and adding the correct version. Java 8 is needed to build Android 7.x.x.</p>
<ol>
<li style="margin-bottom: 10px">On your computer: In a terminal window, enter the following command:
<pre class="prettyprint">sudo apt-get purge openjdk-\* icedtea-\* icedtea6-\*</pre>
</li>
<li style="margin-bottom: 10px">A guide will appear on the screen. Follow the instructions to remove Java.</li>
<li style="margin-bottom: 10px">Once Java is removed, install the correct version of Java by entering the following commands in a terminal window:
<pre class="prettyprint">sudo apt-get update
sudo apt-get install openjdk-8-jdk
java -version</pre>
<p>You should now see something similar to the following in your terminal window:</p>
<pre class="prettyprint">java version "1.8.0_91"
OpenJDK Runtime Environment (build 1.8.0_91-8u91-b14-0ubuntu4~14.04-b14)
OpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode)</pre>
</li>
</ol>
<p><strong>Install the necessary tools to make an Android build<br />
</strong>To be able to build the images that you will later flash on your device, you need to install a set of software packages and libraries which give you the tools to compile source code into binary files that can run on your device.</p>
<ol>
<li style="margin-bottom: 10px">In a terminal window, enter the following commands, all at once:</li>
<li style="margin-bottom: 10px">
<pre class="prettyprint">sudo apt-get install bison g++-multilib git gperf libxml2-utils make zlib1g-dev:i386 zip</pre>
</li>
</ol>
<p>Now you have the tools you need to compile and build a flashable AOSP image. Follow the steps below to learn how to do this.</p>
<p><strong>Download Repo tool and set PATH<br />
</strong>In order to access and use the source code available on the Sonyxperiadev GitHub, you need to install the <a title="Repo tool" href="https://source.android.com/source/developing.html" target="_blank">Repo tool</a> that is provided by Google.</p>
<ol>
<li style="margin-bottom: 10px">In a terminal window, enter the following commands to download and install Repo, and set the right access rules for it:</li>
<li style="margin-bottom: 10px">
<pre class="prettyprint">mkdir ~/bin
curl http://commondatastorage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo
chmod a+x ~/bin/repo</pre>
</li>
<li style="margin-bottom: 10px">Open the bashrc file included in the repo tool:
<pre class="prettyprint">sudo nano ~/.bashrc</pre>
</li>
<li style="margin-bottom: 10px">To set the right path for your local bin folder, paste the following code to a new line at the very bottom of the bashrc file, and then save the file using Ctrl+X:
<pre class="prettyprint">export PATH=~/bin:$PATH</pre>
</li>
<li style="margin-bottom: 10px">Reload bash variables to include the new path:
<pre class="prettyprint">source ~/.bashrc</pre>
</li>
</ol>
<p>Now you have all the tools you need and can move on to initializing the AOSP code and Xperia device configurations. Learn how to do this below!</p>
<p><strong>Initialise the AOSP tree<br />
</strong>The next step is to create a folder on your computer, and then download the Android source code to it. Follow the steps below to do this.</p>
<ol>
<li style="margin-bottom: 10px">In a terminal window, enter the following commands:
<pre class="prettyprint">mkdir ~/android
cd ~/android
repo init -u https://android.googlesource.com/platform/manifest -b android-7.1.1_r8</pre>
<p><strong>Note!</strong> The downloaded data is around 20 GB, and for a successful build you need 100 GB free hard disk space. Depending on your Internet connection, it can take quite a long time to download the source code. When the download has finished you have the basic AOSP source code on your computer.</li>
<li style="margin-bottom: 10px">Create and open a file where you will later add Sony’s repos containing the device configurations for Xperia devices, by entering the following commands:
<pre class="prettyprint">mkdir .repo/local_manifests/
nano .repo/local_manifests/sony.xml</pre>
</li>
<li style="margin-bottom: 10px">Add repos for Xperia devices by copying and pasting the following text into the file, and then save the file using Ctrl+X:
<pre><pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;manifest&gt;
&lt;remote name=&quot;sony&quot; fetch=&quot;https://github.com/sonyxperiadev/&quot; /&gt;
&lt;remove-project name=&quot;platform/hardware/qcom/camera&quot; /&gt;
&lt;project path=&quot;device/sony/sepolicy&quot; name=&quot;device-sony-sepolicy&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/common&quot; name=&quot;device-sony-common&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/common-init&quot; name=&quot;device-sony-common-init&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/dora&quot; name=&quot;device-sony-dora&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/kanuti&quot; name=&quot;device-sony-kanuti&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/kugo&quot; name=&quot;device-sony-kugo&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/loire&quot; name=&quot;device-sony-loire&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/ivy&quot; name=&quot;device-sony-ivy&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/kagura&quot; name=&quot;device-sony-kagura&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/karin&quot; name=&quot;device-sony-karin&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/karin_windy&quot; name=&quot;device-sony-karin_windy&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/kitakami&quot; name=&quot;device-sony-kitakami&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/satsuki&quot; name=&quot;device-sony-satsuki&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/sumire&quot; name=&quot;device-sony-sumire&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/suzuran&quot; name=&quot;device-sony-suzuran&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/suzu&quot; name=&quot;device-sony-suzu&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/tone&quot; name=&quot;device-sony-tone&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/tulip&quot; name=&quot;device-sony-tulip&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;device/sony/common-headers&quot; name=&quot;device-sony-common-headers&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;aosp/LA.UM.5.5.r1&quot; /&gt;
&lt;project path=&quot;device/sony/common-kernel&quot; name=&quot;vendor-sony-kernel&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;aosp/LA.UM.5.5.r1&quot; /&gt;
&lt;project path=&quot;hardware/qcom/camera&quot; name=&quot;camera&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;aosp/LA.UM.5.5.r1&quot; /&gt;
&lt;project path=&quot;kernel/sony/msm&quot; name=&quot;kernel&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;aosp/LA.UM.5.5.r1&quot; /&gt;
&lt;project path=&quot;vendor/qcom/opensource/dataservices&quot; name=&quot;vendor-qcom-opensource-dataservices&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;vendor/qcom/opensource/location&quot; name=&quot;vendor-qcom-opensource-location&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;vendor/sony-oss/thermanager&quot; name=&quot;thermanager&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;vendor/sony-oss/macaddrsetup&quot; name=&quot;macaddrsetup&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;vendor/sony-oss/timekeep&quot; name=&quot;timekeep&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;packages/apps/ExtendedSettings&quot; name=&quot;packages_apps_ExtendedSettings&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;project path=&quot;packages/apps/FMRadio&quot; name=&quot;packages-apps-FMRadio&quot; groups=&quot;device&quot; remote=&quot;sony&quot; revision=&quot;master&quot; /&gt;
&lt;/manifest&gt;

</pre></pre>
<p><strong>Note!</strong> These repos include a precompiled kernel. If you want to change or improve the kernel, you can recompile a new kernel. The new kernel binary should be placed in the corresponding device repository along with new kernel modules for wireless hardware. For more information, see the page <a title="How to build and flash a Linux kernel" href="/knowledge-base/open-source/open-devices/how-to-build-and-flash-a-linux-kernel/">how to rebuild kernels for flagship Xperia devices</a>.</li>
<li style="margin-bottom: 10px">Find the software binaries for the device you want to use on <a title="List of devices and resources" href="http://developer.sonymobile.com/open-devices/list-of-devices-and-resources/">Sony’s AOSP for Xperia devices</a></li>
<li style="margin-bottom: 10px">In the root of your Android code tree, unzip the software binaries file you downloaded in step 4.</li>
<li style="margin-bottom: 10px">You should now have a number of new directories in your <em>vendor</em> To make sure, enter the following command in a terminal window:
<pre class="prettyprint">ls vendor/sony</pre>
<p>This should give you the output:</p>
<pre class="prettyprint">kanuti-common   kanuti-tulip   kitakami-common   kitakami-ivy   kitakami-karin   kitakami-satsuki   kitakami-sumire   kitakami-suzuran   loire-common   loire-suzu   lore-kugo   tone-common tone-dora tone-kagura</pre>
</li>
<li style="margin-bottom: 10px">To download the code into the device repos created above, run the command
<pre class="prettyprint">repo sync</pre>
</li>
</ol>
<p><strong>Add necessary patches from the AOSP upstream branch<br />
</strong>In order for certain functions to work on the hardware in Xperia devices, you need to add a set of patches from the AOSP master branch. This is done by executing the following commands:</p>
<ol>
<li>In a terminal window, enter:
<pre class="prettyprint">cd external/toybox
git fetch https://android.googlesource.com/platform/external/toybox refs/changes/74/265074/1 &amp;&amp; git cherry-pick FETCH_HEAD
git cherry-pick d3e8dd1bf56afc2277960472a46907d419e4b3da
git cherry-pick 1c028ca33dc059a9d8f18daafcd77b5950268f41
git cherry-pick cb49c305e3c78179b19d6f174ae73309544292b8
cd ../../hardware/qcom/audio
git fetch https://android.googlesource.com/platform/hardware/qcom/audio refs/changes/91/294291/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../../system/core
git fetch https://android.googlesource.com/platform/system/core refs/changes/52/269652/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/system/core refs/changes/99/327399/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../packages/apps/Music
git cherry-pick 6036ce6127022880a3d9c99bd15db4c968f3e6a3
cd ../../../

</pre>
</li>
</ol>
<p><strong>Note! </strong>This information will be updated continuously for new Android versions and new devices, so you should always check the AOSP section on Developer World for the latest patches.</p>
<p><strong>Build AOSP images that can be flashed<br />
</strong>Now you are ready to build AOSP images that can be flashed to a device. To do this, you have to point out your specific device and then start building the images.</p>
<ol>
<li style="margin-bottom: 10px">Enter the following commands:
<pre class="prettyprint">source build/envsetup.sh &amp;&amp; lunch</pre>
</li>
<li style="margin-bottom: 10px">When prompted, pick the number corresponding to your device in the list displayed and press enter.</li>
<li style="margin-bottom: 10px">To start the build, type:
<pre class="prettyprint">make –j &lt;insert the cpu thread number of your computer&gt;</pre>
<p>This step will take a long time. It may take up to several hours, so go grab a coffee or play a game while you wait. When it’s done, AOSP images that can be flashed to a device will be ready.</li>
</ol>
<p><strong>Flash AOSP image to your device</strong><br />
Before you flash the images that you built in the previous step, you must make sure your device is unlocked through Sony’s <a title="Unlock boot loader" href="/unlockbootloader/">unlock boot loader</a> service. Then you can flash the AOSP images on your device by following these steps:</p>
<ol>
<li style="margin-bottom: 10px">On your device: Connect the device to your computer in Fastboot mode, by pressing volume up while inserting the USB cable. When the device is in Fastboot mode, the LED on the device will be illuminated in blue.</li>
<li style="margin-bottom: 10px">On your computer: Flash the boot, system and userdata images by entering the following commands in a terminal window:
<pre class="prettyprint">fastboot –S 256M flash boot out/target/product/&lt;device&gt;/boot.img
fastboot –S 256M flash system out/target/product/&lt;device&gt;/system.img
fastboot –S 256M flash userdata out/target/product/&lt;device&gt;/userdata.img</pre>
<p><strong>Note!</strong>It’s not necessary to re-flash the userdata every time you flash your device, but sometimes the new software is incompatible with previous content, which might result in a device that doesn&#8217;t boot. If you experience this, try to re-flash only the userdata again.</li>
<li style="margin-bottom: 10px">Now when you disconnect your device from the computer and start it, it will be running AOSP.</li>
</ol>
<p>We hope this tutorial will help you get started building your own version of Android for Xperia devices. Feel free to contribute your work back to our repositories on our <a title="GitHub" href="https://github.com/sonyxperiadev" target="_blank">Sonyxperiadev GitHub</a> account. We will review and merge your code as soon as possible.</p>
</dd>
