<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">

  <title></title>
</head>

<body>
  <dl>
    <dt id="build-aosp-marshmallow-6-0"><a class="question" href="#build-aosp-marshmallow-6-0">Build AOSP Marshmallow 6.0</a></dt>
  </dl>

  <p>This guide assumes you run Ubuntu (we used Ubuntu 14.04 LTS), but it should work in a similar way on any Linux-based system. To use&Acirc;&nbsp;these instructions, you should be familiar with Android development. Follow the steps below to build Android Marshmallow on an unlocked Xperia device. The instructions will guide you through each step from how to prepare your environment and install all necessary tools to downloading and configuring the code, before you can finally build AOSP images and flash them on your device.</p>

  <p><strong>Prepare your Java environment<br></strong>To prevent errors generated by having the wrong version of Java installed on your computer, we will start by removing any conflicting Java version and adding the correct version. Java 7 is needed to build Android 6.x.x.</p>

  <ol>
    <li style="margin-bottom: 10px">On your computer: In a terminal window, enter the following command:
      <pre class="prettyprint">
sudo apt-get purge openjdk-\* icedtea-\* icedtea6-\*
</pre>
    </li>

    <li style="margin-bottom: 10px">A guide will appear on the screen. Follow the instructions to remove Java.</li>

    <li style="margin-bottom: 10px">Once&Acirc;&nbsp;Java is removed, install the correct version of Java by entering the following commands in a terminal window:
      <pre class="prettyprint">
sudo apt-get update
sudo apt-get install openjdk-7-jdk
java -version
</pre>

      <p>You should now see something similar to the following in your terminal window:</p>
      <pre class="prettyprint">
java version "1.7.0_65"
OpenJDK Runtime Environment (IcedTea 2.5.3)
OpenJDK 64-Bit Server VM (build 24.65-b04, mixed mode)
</pre>
    </li>
  </ol>

  <p><strong>Install the necessary tools to make an Android build<br></strong>To be able to build the images that you will later flash on your device, you need to install a set of software packages and libraries which give you the tools to compile source code into binary files that can run on your device.</p>

  <ol>
    <li style="margin-bottom: 10px">In a terminal window, enter the following commands, all at once:
      <pre class="prettyprint">
sudo apt-get&Acirc; install bison g++-multilib git gperf libxml2-utils make zlib1g-dev:i386 zip
</pre>
    </li>
  </ol>

  <p>Now you have the tools you need to compile and build a flashable AOSP image. Follow the steps below to learn how to do this.</p>

  <p><strong>Download Repo tool and set PATH<br></strong>In order to access and use the source code available on the Sonyxperiadev GitHub, you need to install the <a title="Repo tool" href="https://source.android.com/source/developing.html" target="_blank">Repo tool</a> that is provided by Google.</p>

  <ol>
    <li style="margin-bottom: 10px">In a terminal window, enter the following commands to download and install Repo, and set the right access rules for it:
      <pre class="prettyprint">
mkdir ~/bin
curl http://commondatastorage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo
chmod a+x ~/bin/repo
</pre>
    </li>

    <li style="margin-bottom: 10px">Open the bashrc file included in the repo tool:
      <pre class="prettyprint">
sudo nano ~/.bashrc
</pre>
    </li>

    <li style="margin-bottom: 10px">To set the right path for your local bin folder, paste the following code to a new line at the very bottom of the bashrc file, and then save the file using Ctrl+X:
      <pre class="prettyprint">
export PATH=~/bin:$PATH
</pre>
    </li>

    <li style="margin-bottom: 10px">Reload bash variables to include the new path:
      <pre class="prettyprint">
source ~/.bashrc
</pre>
    </li>
  </ol>

  <p>Now you have all the tools you need and can move on to initialising the AOSP code and Xperia device configurations. Learn how to do this below!</p>

  <p><strong>Initialise the AOSP tree<br></strong>The next step is to create a folder on your computer, and then download the Android source code to it. Follow the steps below to do this.</p>

  <ol>
    <li style="margin-bottom: 10px">In a terminal window, enter the following commands:
      <pre class="prettyprint">
mkdir ~/android
cd ~/android
repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.0_r26
</pre>

      <p><strong>Note!</strong> The downloaded data is around 20 GB, and for a succesful build you need 100 GB free hard disk space. Depending on your Internet connection, it can take quite a long time to download the source code. When the download has finished you have the basic AOSP source code on your computer.</p>
    </li>

    <li style="margin-bottom: 10px">Create and open a file where you will later add Sony&acirc;&euro;&trade;s repos containing the device configurations for Xperia devices, by entering the following commands:
      <pre class="prettyprint">
mkdir .repo/local_manifests/
nano .repo/local_manifests/sony.xml
</pre>
    </li>

    <li style="margin-bottom: 10px">Add repos for Xperia devices by copying and pasting the following text into the file, and then save the file using Ctrl+X:
      <pre class="prettyprint">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;manifest&gt;
&lt;remote name="sony" fetch="git://github.com/sonyxperiadev/" /&gt;
&lt;remove-project name="platform/hardware/qcom/camera" /&gt;
&lt;project path="device/sony/sepolicy" name="device-sony-sepolicy" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/amami" name="device-sony-amami" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/aries" name="device-sony-aries" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/castor" name="device-sony-castor" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/castor_windy" name="device-sony-castor_windy" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/common" name="device-sony-common" groups="device" remote="sony" revision="m-mr0" /&gt;
&lt;project path="device/sony/common-headers" name="device-sony-common-headers" groups="device" remote="sony" revision="aosp/LA.BF64.1.2.2_rb4.7" /&gt;
&lt;project path="device/sony/common-kernel" name="vendor-sony-kernel" groups="device" remote="sony" revision="aosp/LA.BF64.1.2.2_rb4.7" /&gt;
&lt;project path="device/sony/eagle" name="device-sony-eagle" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/flamingo" name="device-sony-flamingo" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/honami" name="device-sony-honami" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/kanuti" name="device-sony-kanuti" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/ivy" name="device-sony-ivy" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/karin" name="device-sony-karin" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/karin_windy" name="device-sony-karin_windy" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/kitakami" name="device-sony-kitakami" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/leo" name="device-sony-leo" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/rhine" name="device-sony-rhine" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/satsuki" name="device-sony-satsuki" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/scorpion" name="device-sony-scorpion" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/scorpion_windy" name="device-sony-scorpion_windy" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/seagull" name="device-sony-seagull" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/shinano" name="device-sony-shinano" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/sirius" name="device-sony-sirius" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/sumire" name="device-sony-sumire" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/suzuran" name="device-sony-suzuran" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/tianchi" name="device-sony-tianchi" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/togari" name="device-sony-togari" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/tulip" name="device-sony-tulip" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="device/sony/yukon" name="device-sony-yukon" groups="device" remote="sony" revision="m-mr1" /&gt;
&lt;project path="hardware/qcom/camera" name="camera" groups="device" remote="sony" revision="aosp/LA.BF64.1.2.2_rb4.7" /&gt;
&lt;project path="kernel/sony/msm" name="kernel" groups="device" remote="sony" revision="aosp/LA.BF64.1.2.2_rb4.7" /&gt;
&lt;project path="vendor/qcom/opensource/dataservices" name="vendor-qcom-opensource-dataservices" groups="device" remote="sony" revision="master" /&gt;
&lt;project path="vendor/sony-oss/thermanager" name="thermanager" groups="device" remote="sony" revision="master" /&gt;
&lt;project path="vendor/sony-oss/mkqcdtbootimg" name="mkqcdtbootimg" groups="device" remote="sony" revision="master" /&gt;
&lt;project path="vendor/sony-oss/macaddrsetup" name="macaddrsetup" groups="device" remote="sony" revision="master" /&gt;
&lt;project path="vendor/sony-oss/timekeep" name="timekeep" groups="device" remote="sony" revision="master" /&gt;
&lt;/manifest&gt;
</pre>

      <p><strong>Note!</strong> These repos include a precompiled kernel. If you want to change or improve the kernel, you can recompile a new kernel. The new kernel binary should be placed in the corresponding device repository along with new kernel modules for wireless hardware. For more information, see the page&Acirc;&nbsp;<a title="How to build and flash a Linux kernel" href="/knowledge-base/open-source/open-devices/how-to-build-and-flash-a-linux-kernel/">how to rebuild kernels for flagship Xperia devices</a>.</p>
    </li>

    <li style="margin-bottom: 10px">Find and download the software binaries for the device you want to use on <a title="List of devices and resources" href="http://developer.sonymobile.com/open-devices/list-of-devices-and-resources/">Sony&acirc;&euro;&trade;s AOSP for Xperia devices</a></li>

    <li style="margin-bottom: 10px">In the root of your Android code tree, unzip the software binaries file you downloaded.</li>

    <li style="margin-bottom: 10px">You should now have a number of new directories in your <em>vendor</em> To make sure, enter the following command in a terminal window:
      <pre class="prettyprint">
ls vendor/sony
</pre>

      <p>This should give you the output:</p>
      <pre class="prettyprint">
amami aries castor eagle flamingo honami kanuti ivy karin karin_windy kitakami leo rhine satsuki scorpion seagull shinano sirius sumire suzuran tianchi togari tulip yukon
</pre>
    </li>

    <li style="margin-bottom: 10px">To download the code into the device repos created above, run the command:
      <pre class="prettyprint">
repo sync
</pre>
    </li>
  </ol>

  <p><strong>Add necessary patches from the AOSP upstream branch<br></strong>In order for certain functions to work on the hardware in Xperia devices, you need to add a set of patches from the AOSP master branch. This is done by executing the following commands:</p>

  <ol>
    <li>In a terminal window, enter:
      <pre class="prettyprint">
cd external/libnfc-nci
git fetch https://android.googlesource.com/platform/external/libnfc-nci refs/changes/61/170861/2 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../toybox
git fetch https://android.googlesource.com/platform/external/toybox refs/changes/53/265153/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../hardware/qcom/gps
git revert --no-edit 5c7552e789e4f039bebb09b972425a6cb47fc8e8
cd ../display
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/70/238470/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/52/265052/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/53/265053/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/92/265092/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/54/274454/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/display refs/changes/55/274455/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../audio
git cherry-pick 582e0a5e965897ea54ecfa5fe206797dab577a45
git cherry-pick 48e428ecccee5c585a5bcc2297ea21802861df6e
git fetch https://android.googlesource.com/platform/hardware/qcom/audio refs/changes/10/250410/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/audio refs/changes/13/252313/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../media
git fetch https://android.googlesource.com/platform/hardware/qcom/media refs/changes/90/258490/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../keymaster
git cherry-pick 888834f9aba0609222c6e6bbd86bd6625af28746
git fetch https://android.googlesource.com/platform/hardware/qcom/keymaster refs/changes/70/212570/5 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/keymaster refs/changes/80/212580/2 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/keymaster refs/changes/61/213261/1 &amp;&amp; git cherry-pick FETCH_HEAD
git fetch https://android.googlesource.com/platform/hardware/qcom/keymaster refs/changes/21/245721/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../broadcom/libbt/
git fetch https://android.googlesource.com/platform/hardware/broadcom/libbt refs/changes/17/114817/2 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../../system/core
git cherry-pick 9cb3d3ccf49bf0fd484563fbf611c68789d5b8a9
git fetch https://android.googlesource.com/platform/system/core refs/changes/92/269692/1 &amp;&amp; git cherry-pick FETCH_HEAD
cd ../../packages/apps/Nfc
git revert --no-edit 988c3fff5470a1de3a880bd07fa438cc47e283c8
cd ../../../../../
 
</pre>
    </li>
  </ol>

  <p><strong>Note!</strong> This information will be updated continuously for new Android versions and new devices, so you should always check the AOSP section on Developer World for the latest patches.</p>

  <p><strong>Build AOSP images that can be flashed<br></strong>Now you are ready to build AOSP images that can be flashed to a device. To do this, you have to point out your specific device and then start building the images.</p>

  <ol>
    <li style="margin-bottom: 10px">Enter the following commands:
      <pre class="prettyprint">
source build/envsetup.sh &amp;&amp; lunch
</pre>
    </li>

    <li style="margin-bottom: 10px">When prompted, pick the number corresponding to your device in the list displayed and press enter.</li>

    <li style="margin-bottom: 10px">To start the build, type:
      <pre class="prettyprint">
make &acirc;&euro;&ldquo;j &lt;insert the cpu thread number of your computer&gt;
</pre>

      <p>This step will take a long time. It may take up to several hours, so go grab a coffee or play a game while you wait. When it&acirc;&euro;&trade;s done, AOSP images that can be flashed to a device will be ready.</p>
    </li>
  </ol>

  <p><strong>Flash AOSP image to your device</strong><br>
  Before you flash the images that you built in the previous step, you must make sure your device is unlocked through Sony&acirc;&euro;&trade;s <a title="Unlock boot loader" href="/unlockbootloader/">unlock boot loader</a> service. Then you can flash the AOSP images on your device by following these steps:</p>

  <ol>
    <li style="margin-bottom: 10px">On your device: Connect the device to your computer in Fastboot mode, by pressing volume up while inserting the USB cable. When the device is in Fastboot mode, the LED on the device will be illuminated in blue.</li>

    <li style="margin-bottom: 10px">On your computer: Flash the boot, system and userdata images by entering the following commands in a terminal window:
      <pre class="prettyprint">
fastboot &acirc;&euro;&ldquo;S 256M flash boot out/target/product/&lt;device&gt;/boot.img
fastboot &acirc;&euro;&ldquo;S 256M flash system out/target/product/&lt;device&gt;/system.img
fastboot &acirc;&euro;&ldquo;S 256M flash userdata out/target/product/&lt;device&gt;/userdata.img
</pre>

      <p><strong>Note!</strong>It&acirc;&euro;&trade;s not necessary to re-flash the userdata every time you flash your device, but sometimes the new software is incompatible with previous content, which might result in a device that doesn&rsquo;t boot. If you experience this, try to re-flash only the userdata again.</p>
    </li>

    <li style="margin-bottom: 10px">Now when you disconnect your device from the computer and start it, it will be running AOSP.</li>
  </ol>

  <p>We hope this tutorial will help you get started building your own version of Android for Xperia devices. Feel free to contribute your work back to our repositories on our <a title="GitHub" href="https://github.com/sonyxperiadev" target="_blank">Sonyxperiadev GitHub</a> account. We will review and merge your code as soon as possible.</p>
</body>
</html>
