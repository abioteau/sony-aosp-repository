<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
  <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">

  <title></title>
</head>

<body>
  <div id="main" role="main">
    <h1 class="page-title">How to build AOSP KitKat for unlocked Xperia devices</h1>

    <div class="page-content">
      <p>This is a&Acirc;&nbsp;guide &Acirc;&nbsp;to how to use our <a href="/open-devices/list-of-devices-and-resources/" title="List of devices and resources">AOSP device configurations</a> to build your own version of Android, and flash it on your unlocked Xperia device. For some of the Xperia devices, we provide Android Open Source Project (AOSP) device configurations on GitHub. This means that the software is open for you as a developer to use and contribute to. Please note that the software is not intended for daily usage and there are important limitations. For example, there could be stability issues, and important functions may be disabled.</p>

      <p>This guide assumes you run Ubuntu (we used Ubuntu 14.04 LTS), but it should work in a similar way on any Linux-based system. To use&Acirc;&nbsp;these instructions, you should be familiar with Android development. Follow the steps below to build Android 4.4 on an unlocked Xperia device. The instructions will guide you through each step from how to prepare your environment and install all necessary tools to downloading and configuring the code, before you can finally build AOSP images and flash them on your device.</p>

      <p><strong>Prepare your Java environment<br></strong>To prevent errors generated by having the wrong version of Java installed on your computer, we will start by removing any conflicting Java version and adding the correct version. Java 6 is needed to build Android 4.4.x.</p>

      <ol>
        <li>On your computer: In a terminal window, enter the following command:<br>
        <code>sudo apt-get purge openjdk-\* icedtea-\* icedtea6-\*</code></li>

        <li>A guide will appear on the screen. Follow the instructions to remove Java.</li>

        <li>Once&Acirc;&nbsp;Java is removed, install the correct version of Java by entering the following commands in a terminal window:<br>
        <code>sudo add-apt-repository ppa:webupd8team/java<br>
        sudo apt-get update &amp;&amp; sudo apt-get install oracle-java6-installer<br>
        java -version</code><br>
        You should now see something similar to the following in your terminal window:<br>
        <code>java version "1.6.0_45"<br>
        Java(TM) SE Runtime Environment (build 1.6.0_45-b06)<br>
        Java HotSpot(TM) 64-Bit Server VM (build 20.45-b01, mixed mode)<br></code></li>
      </ol>

      <p><strong>Install the necessary tools to make an Android build<br></strong>To be able to build the images that you will later flash on your device, you need to install a set of software packages and libraries which give you the tools to compile source code into binary files that can run on your device.</p>

      <ol>
        <li>In a terminal window, enter the following commands, all at once:<br>
        <code>sudo apt-get install git gnupg ccache lzop flex bison gperf build-essential zip curl zlib1g-dev zlib1g-dev:i386 libc6-dev lib32bz2-1.0 lib32ncurses5-dev x11proto-core-dev libx11-dev:i386 libreadline6-dev:i386 lib32z1-dev libgl1-mesa-glx:i386 libgl1-mesa-dev g++-multilib mingw32 tofrodos python-markdown libxml2-utils xsltproc libreadline6-dev lib32readline-gplv2-dev libncurses5-dev bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev lib32bz2-dev squashfs-tools pngcrush schedtool dpkg-dev<br>
        sudo ln -s /usr/lib/i386-linux-gnu/mesa/libGL.so.1 /usr/lib/i386-linux-gnu/libGL.so<br></code></li>
      </ol>

      <p>Now you have the tools you need to compile and build a flashable AOSP image. Follow the steps below to learn how to do this.</p>

      <p><strong>Download Repo tool and set PATH<br></strong>In order to access and use the source code available on the Sonyxperiadev GitHub, you need to install the <a href="https://source.android.com/source/developing.html" title="Repo tool" target="_blank">Repo tool</a> that is provided by Google.</p>

      <ol>
        <li>In a terminal window, enter the following commands to download and install Repo, and set the right access rules for it:<br>
        <code>mkdir ~/bin<br>
        curl http://commondatastorage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo<br>
        chmod a+x ~/bin/repo</code></li>

        <li>Open the bashrc file included in the repo tool:<br>
        <code>sudo nano ~/.bashrc</code></li>

        <li>To set the right path for your local bin folder, paste the following code to a new line at the very bottom of the bashrc file, and then save the file using Ctrl+X:<br>
        <code>export PATH=~/bin:$PATH</code></li>

        <li>Reload bash variables to include the new path:<br>
        <code>source ~/.bashrc</code></li>
      </ol>

      <p>Now you have all the tools you need and can move on to initialising the AOSP code and Xperia device configurations. Learn how to do this below!</p>

      <p><strong>Initialise the AOSP tree<br></strong>The next step is to create a folder on your computer, and then download the Android source code to it. Follow the steps below to do this.</p>

      <ol>
        <li>In a terminal window, enter the following commands:<br>
        <code>mkdir ~/android<br>
        cd ~/android<br>
        repo init -u https://android.googlesource.com/platform/manifest -b android-4.4.4_r2<br>
        repo sync</code><strong>Note!</strong> The downloaded data is around 10 GB. Depending on your Internet connection, it can take quite a long time to download the source code. When the download has finished you have the basic AOSP source code on your computer.</li>

        <li>Create and open a file where you will later add Sony&acirc;&euro;&trade;s repos containing the device configurations for Xperia devices, by entering the following commands:<br>
        <code>mkdir .repo/local_manifests/<br>
        nano .repo/local_manifests/sony.xml</code></li>
      </ol>

      <ol start="3">
        <li>Add repos for Xperia devices by copying and pasting the following text into the file, and then save the file using Ctrl+X:<br>
        <code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br>
        &lt;manifest&gt;<br>
        &lt;remote name="sony" fetch="git://github.com/sonyxperiadev/" /&gt;<br>
        &lt;remove-project name="platform/hardware/qcom/keymaster" /&gt;<br>
        &lt;remove-project name="platform/hardware/qcom/media" /&gt;<br>
        &lt;remove-project name="platform/hardware/qcom/msm8960" /&gt;<br>
        &lt;remove-project name="platform/hardware/qcom/sensors" /&gt;<br>
        &lt;remove-project name="platform/hardware/invensense" /&gt;<br>
        &lt;remove-project name="platform/hardware/akm" /&gt;<br>
        &lt;project path="device/sony/lagan" name="device-sony-lagan" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/yuga" name="device-sony-yuga" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/rhine" name="device-sony-rhine" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/honami" name="device-sony-honami" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/shinano" name="device-sony-shinano" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/sirius" name="device-sony-sirius" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/yukon" name="device-sony-yukon" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/eagle" name="device-sony-eagle" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/flamingo" name="device-sony-flamingo" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/seagull" name="device-sony-seagull" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="device/sony/tianchi" name="device-sony-tianchi" groups="device" remote="sony" revision="kk_mr2" /&gt;<br>
        &lt;project path="vendor/sony/system/dash" name="DASH" groups="device" remote="sony" revision="master" /&gt;<br>
        &lt;project path="vendor/sony/system/thermanager" name="thermanager" groups="device" remote="sony" revision="master" /&gt;<br>
        &lt;project path="vendor/sony/system/mkqcdtbootimg" name="mkqcdtbootimg" groups="device" remote="sony" revision="master" /&gt;<br>
        &lt;/manifest&gt;<br></code><br>
        <strong>Note!</strong> These repos include a precompiled kernel. If you want to change or improve the kernel, you can recompile a new kernel. The new kernel binary should be placed in the corresponding device repository along with new kernel modules for wireless hardware. For more information, see the page&Acirc;&nbsp;<a href="/knowledge-base/open-source/open-devices/how-to-build-and-flash-a-linux-kernel/" title="How to build and flash a Linux kernel">how to rebuild kernels for flagship Xperia devices</a>.</li>
      </ol>

      <ol start="4">
        <li>Find the software binaries for the device you want to use on <a href="/open-source/open-devices/list-of-devices-and-resources/" title="List of devices and resources">Sony&acirc;&euro;&trade;s AOSP for Xperia devices</a></li>

        <li>In the root of your Android code tree, unzip the software binaries file you downloaded in step 4.</li>

        <li>You should now have a number of new directories in your <em>vendor</em> To make sure, enter the following command in a terminal window:<br>
        <code>ls vendor/sony</code>This should give you the output:<code>eagle flamingo honami lagan rhine seagull shinano sirius system tianchi yuga yukon</code></li>
      </ol>

      <ol start="7">
        <li>To download the code into the device repos created above, run the command<code>repo sync</code></li>
      </ol>

      <p><strong>Add necessary patches from the AOSP upstream branch<br></strong>In order for certain functions to work on the hardware in Xperia devices, you need to add a set of patches from the AOSP master branch. This is done by executing the following commands:</p>

      <ol>
        <li>In a terminal window, enter:<br>
        <code>cd build<br>
        git cherry-pick 612e2cd0e8c79bc6ab46d13cd96c01d1be382139<br>
        cd ..<br>
        cd hardware/qcom/bt<br>
        git cherry-pick 5a6037f1c8b5ff0cf263c9e63777444ba239a056<br>
        cd ../../../<br>
        cd hardware/qcom/audio<br>
        git cherry-pick 00f6869a0981b570f90dbf39981734f36eafdfa9<br>
        git cherry-pick 20bcfa8b451941843e8eabb5308f1f04f07d347a<br>
        cd ../../../<br>
        cd hardware/qcom/display<br>
        git cherry-pick d5ae1812a9509d8849f4494fcf17f68bf33f533c<br>
        git cherry-pick 5898f2e789800fb196ce94532eef033e7d7e60b3<br>
        cd ../../../</code></li>
      </ol>

      <p><strong>Note!</strong> This information will be updated continuously for new Android versions and new devices, so you should always check the AOSP section on Developer World for the latest patches.</p>

      <p><strong>Build AOSP images that can be flashed<br></strong>Now you are ready to build AOSP images that can be flashed to a device. To do this, you have to point out your specific device and then start building the images.</p>

      <ol>
        <li>Enter the following commands:<br>
        <code>source build/envsetup.sh &amp;&amp; lunch</code></li>

        <li>When prompted, pick the number corresponding to your device in the list displayed and press enter.</li>

        <li>To start the build, type:<br>
        <code>make &acirc;&euro;&ldquo;j <em>&lt;insert the cpu thread number of your computer&gt;</em></code><br>
        This step will take a long time. It may take up to several hours, so go grab a coffee or play a game while you wait. When it&acirc;&euro;&trade;s done, AOSP images that can be flashed to a device will be ready.</li>
      </ol>

      <p><strong>Flash AOSP image to your device</strong><br>
      Before you flash the images that you built in the previous step, you must make sure your device is unlocked through Sony&acirc;&euro;&trade;s <a href="/unlockbootloader/" title="Unlock boot loader">unlock boot loader</a> service. Then you can flash the AOSP images on your device by following these steps:</p>

      <ol>
        <li>On your device: Connect the device to your computer in Fastboot mode, by pressing volume up while inserting the USB cable. When the device is in Fastboot mode, the LED on the device will be illuminated in blue.</li>

        <li>On your computer: Flash the boot, system and userdata images by entering the following commands in a terminal window:<br>
        <code>fastboot flash boot out/target/product/&lt;device&gt;/boot.img<br>
        fastboot flash system out/target/product/&lt;device&gt;/system.img<br>
        fastboot flash userdata out/target/product/&lt;device&gt;/userdata.img</code>It&acirc;&euro;&trade;s not necessary to re-flash the userdata every time you flash your device, but sometimes the new software is incompatible with previous content, which might result in a device that doesn&rsquo;t boot. If you experience this, try to re-flash only the userdata again.</li>
      </ol>

      <ol start="3">
        <li>Now when you disconnect your device from the computer and start it, it will be running AOSP.</li>
      </ol>

      <p>We hope this tutorial will help you get started building your own version of Android for Xperia devices. Feel free to contribute your work back to our repositories on our <a href="https://github.com/sonyxperiadev" title="GitHub" target="_blank">Sonyxperiadev GitHub</a> account. We will review and merge your code as soon as possible.</p>
    </div><script src="//www.google.com/recaptcha/api.js?render=explicit&amp;onload=grecaptcha_onload&amp;hl=en" type="text/javascript">
</script>

    <div class="box" id="feedback-component" style="margin-bottom: 20px; min-height: 80px;">
      <div class="box-header clear-children feedback-title">
        <h3 class="box-title reply-title">Was this page helpful?</h3>
      </div>

      <div class="feedback-loader-dinamic"></div>

      <div id="feedback-error-msg"></div>

      <div id="feedback-buttons" class="box-content clear-children feedback">
        <button id="feedback-yes" class="btn btn-primary btn-feedback-answer" onclick="WTIH.validateRequest(24739, true)">Yes</button> <button id="feedback-no" class="btn btn-primary btn-feedback-answer" onclick="WTIH.validateRequest(24739, false)">No</button> <button id="feedback-retry" class="btn btn-primary btn-feedback-retry" onclick="WTIH.retrySendFeedback(24739)">Retry</button>
      </div>

      <p id="test-hidden"><label>If you're human leave this field blank:</label> <input name="test-hidden" type="text" value=""></p>

      <div id="seg-recaptcha" data-sitekey="6Ld4uwATAAAAAMBIp7K1_QOD5EI-96k2MPtk0ytg"></div>

      <div id="seg-recaptcha-blacklist" data-sitekey="6Ld4uwATAAAAAMBIp7K1_QOD5EI-96k2MPtk0ytg"></div>

      <div id="loading-dots"></div><input id="feedback-nonce" type="hidden"> <input id="feedback-answer" type="hidden">
    </div>
  </div>
</body>
</html>
